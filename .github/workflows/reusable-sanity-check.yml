name: Reusable Sanity Check

on:
  workflow_call:
    inputs:
      terraform-version:
        required: false
        type: string
        default: '1.6.0'
      create-pr:
        required: false
        type: boolean
        default: true
    secrets:
      github-token:
        required: true

jobs:
  sanity-check:
    runs-on: ubuntu-latest
    outputs:
      has-changes: ${{ steps.changes.outputs.has-changes }}
      branch-name: ${{ steps.branch.outputs.branch-name }}
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.github-token }}
        fetch-depth: 0

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ inputs.terraform-version }}

    - name: Install Analysis Tools
      run: |
        pip3 install checkov tfsec
        curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash

    - name: Run Terraform Format
      run: |
        find . -name "*.tf" -exec dirname {} \; | sort -u | while read dir; do
          if [ -f "$dir/main.tf" ] || [ -f "$dir/variables.tf" ]; then
            echo "â†’ Formatting $dir"
            cd "$dir" && terraform fmt && cd - > /dev/null
          fi
        done

    - name: Run TFLint Analysis
      continue-on-error: true
      run: |
        find . -name "*.tf" -exec dirname {} \; | sort -u | while read dir; do
          if [ -f "$dir/main.tf" ] || [ -f "$dir/variables.tf" ]; then
            echo "â†’ Linting $dir"
            cd "$dir" && tflint --format=compact && cd - > /dev/null
          fi
        done

    - name: Run Security Analysis
      continue-on-error: true
      run: |
        echo "â†’ Running security analysis..."
        checkov -d . --framework terraform --compact --quiet --soft-fail
        tfsec . --soft-fail

    - name: Check for Changes
      id: changes
      run: |
        if git diff --quiet; then
          echo "has-changes=false" >> $GITHUB_OUTPUT
          echo "â„¹ï¸ No changes needed"
        else
          echo "has-changes=true" >> $GITHUB_OUTPUT
          echo "ðŸ“ Changes detected"
          git diff --name-only
        fi

    - name: Create PR Branch
      id: branch
      if: steps.changes.outputs.has-changes == 'true' && inputs.create-pr
      run: |
        BRANCH_NAME="sanity-check/$(date +%Y%m%d-%H%M%S)"
        echo "branch-name=$BRANCH_NAME" >> $GITHUB_OUTPUT
        
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git checkout -b "$BRANCH_NAME"
        git add .
        git commit -m "fix: automated code quality improvements

        - Applied terraform fmt
        - Addressed linting recommendations
        - Applied security best practices"
        git push origin "$BRANCH_NAME"

    - name: Create Pull Request
      if: steps.changes.outputs.has-changes == 'true' && inputs.create-pr
      run: |
        gh pr create \
          --title "ðŸ”§ Automated Code Quality Fixes" \
          --body "## Automated Infrastructure Code Improvements

        This PR contains automated fixes from sanity check analysis:

        ### ðŸ”§ Applied Fixes
        - **Terraform Formatting**: Consistent code formatting
        - **Linting**: Code quality improvements
        - **Security**: Best practice recommendations

        ### ðŸ“‹ Review Checklist
        - [ ] Verify formatting changes are appropriate
        - [ ] Confirm no functional changes introduced
        - [ ] Run full validation pipeline

        ---
        *Auto-generated by sanity check workflow*" \
          --base main \
          --head "${{ steps.branch.outputs.branch-name }}" \
          --label "automated,infrastructure,code-quality"
      env:
        GITHUB_TOKEN: ${{ secrets.github-token }}